<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S-Box Analytics Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Fira+Code&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        .font-mono { font-family: 'Fira Code', monospace; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #a855f7; border-radius: 10px; }
        .glass-card { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Mengambil Komponen dari Library Global
        const { 
            RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, 
            ResponsiveContainer, Tooltip, BarChart, Bar, XAxis, YAxis, 
            CartesianGrid, Legend 
        } = window.Recharts;
        const { useState, useEffect, useMemo } = React;

        // Konstanta Kriptografi
        const AES_CONSTANT = 0x63;
        const IRREDUCIBLE_POLY = 0x11B;

        // --- Logic Kriptografi ---
        const gfMultiply = (a, b) => {
            let p = 0;
            for (let i = 0; i < 8; i++) {
                if (b & 1) p ^= a;
                const hiBitSet = a & 0x80;
                a <<= 1;
                if (hiBitSet) a ^= IRREDUCIBLE_POLY;
                b >>= 1;
            }
            return p & 0xFF;
        };

        const generateInverseTable = () => {
            const inv = new Array(256).fill(0);
            for (let i = 1; i < 256; i++) {
                for (let j = 1; j < 256; j++) {
                    if (gfMultiply(i, j) === 1) { inv[i] = j; break; }
                }
            }
            return inv;
        };
        const INVERSE_TABLE = generateInverseTable();

        const createSboxFromMatrix = (matrix) => {
            const sbox = [];
            for (let x = 0; x < 256; x++) {
                const invX = INVERSE_TABLE[x];
                const invBits = Array.from({ length: 8 }, (_, i) => (invX >> i) & 1);
                const transBits = matrix.map(row => 
                    row.reduce((sum, val, idx) => sum + (val * invBits[idx]), 0) % 2
                );
                let finalVal = 0;
                for (let i = 0; i < 8; i++) if (transBits[i]) finalVal |= (1 << i);
                sbox.push(finalVal ^ AES_CONSTANT);
            }
            return sbox;
        };

        // --- Komponen Utama ---
        const SboxAnalyzer = () => {
            const [data, setData] = useState({ candidates: [] });
            const [selected, setSelected] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterType, setFilterType] = useState('all');
            const [sortBy, setSortBy] = useState('NL');
            const [activeTab, setActiveTab] = useState('analysis');

            // State Enkripsi
            const [input, setInput] = useState('');
            const [outputHex, setOutputHex] = useState('');
            const [outputText, setOutputText] = useState('');
            const [mode, setMode] = useState('text');

            useEffect(() => {
                fetch('/api/data')
                    .then(res => res.json())
                    .then(json => {
                        setData(json);
                        if (json.candidates?.length > 0) setSelected(json.candidates[0]);
                    });
                // Inisialisasi icon Lucide
                if (window.lucide) window.lucide.createIcons();
            }, []);

            // Metadata Metrik
            const metricInfo = {
                NL: { name: 'Nonlinearity', optimal: 'high', threshold: 100, desc: 'Ketahanan linear' },
                SAC: { name: 'SAC', optimal: 'close to 0.5', threshold: 0.5, desc: 'Efek salju' },
                LAP: { name: 'LAP', optimal: 'low', threshold: 0.1, desc: 'Probabilitas Linear' },
                DAP: { name: 'DAP', optimal: 'low', threshold: 0.02, desc: 'Probabilitas Diferensial' },
                DU: { name: 'Diff. Unif', optimal: 'low', threshold: 6, desc: 'Diferensial Seragam' },
                AD: { name: 'Alg. Degree', optimal: 'high', threshold: 6, desc: 'Derajat Aljabar' },
                CI: { name: 'Confusion', optimal: 'high', threshold: 0.95, desc: 'Indeks Kebingungan' }
            };

            const getMetricScore = (value, m) => {
                const info = metricInfo[m];
                if (!info) return 50;
                if (info.optimal === 'high') return Math.min(100, (value / info.threshold) * 100);
                if (info.optimal === 'low') return Math.max(0, 100 - (value / info.threshold) * 100);
                return 100 - Math.abs(value - 0.5) * 200;
            };

            const calculateSecurityScore = (metrics) => {
                const scores = Object.keys(metricInfo).map(k => getMetricScore(metrics[k], k));
                return Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
            };

            const filtered = useMemo(() => {
                return data.candidates
                    .filter(c => (filterType === 'all' || c.type === filterType) && 
                                 c.name.toLowerCase().includes(searchTerm.toLowerCase()))
                    .sort((a, b) => b.metrics[sortBy] - a.metrics[sortBy]);
            }, [data.candidates, searchTerm, filterType, sortBy]);

            const handleProcess = (op) => {
                if (!selected?.matrix || !input) return;
                const currentSbox = createSboxFromMatrix(selected.matrix);
                const invSbox = new Array(256);
                for(let i=0; i<256; i++) invSbox[currentSbox[i]] = i;

                let bytes = [];
                if (mode === 'text') {
                    bytes = Array.from(new TextEncoder().encode(input));
                } else {
                    bytes = input.split(/[\s,]+/).map(h => parseInt(h, 16)).filter(n => !isNaN(n));
                }

                const result = bytes.map(b => op === 'enc' ? currentSbox[b] : invSbox[b]);
                setOutputHex(result.map(b => b.toString(16).padStart(2, '0')).join(' '));
                setOutputText(new TextDecoder().decode(new Uint8Array(result)));
            };

            if (!selected) return <div className="text-white p-20 text-center">Loading Application...</div>;

            return (
                <div className="min-h-screen text-slate-200 bg-gradient-to-br from-slate-900 via-purple-900 to-black p-4 md:p-8">
                    <div className="max-w-7xl mx-auto">
                        <header className="mb-8 flex justify-between items-end border-b border-white/10 pb-6">
                            <div>
                                <h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">S-BOX ANALYZER PRO</h1>
                                <p className="text-purple-300 mt-2">Advanced Security Visualization & Simulation</p>
                            </div>
                            <div className="text-right">
                                <p className="text-xs uppercase text-slate-500 font-bold">Total Candidates</p>
                                <p className="text-3xl font-bold">{data.candidates.length}</p>
                            </div>
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                            {/* Sidebar Filters & List */}
                            <div className="lg:col-span-1 space-y-4">
                                <div className="glass-card p-4 rounded-2xl">
                                    <input type="text" placeholder="Search..." className="w-full bg-black/40 border border-white/10 p-2 rounded-lg mb-3" onChange={e => setSearchTerm(e.target.value)}/>
                                    <select className="w-full bg-black/40 border border-white/10 p-2 rounded-lg mb-3" onChange={e => setFilterType(e.target.value)}>
                                        <option value="all">All Types</option>
                                        <option value="standard">Standard</option>
                                        <option value="proposed">Proposed</option>
                                    </select>
                                    <select className="w-full bg-black/40 border border-white/10 p-2 rounded-lg" onChange={e => setSortBy(e.target.value)}>
                                        <option value="NL">Sort by NL</option>
                                        <option value="CI">Sort by Confusion</option>
                                    </select>
                                </div>
                                <div className="glass-card rounded-2xl h-[500px] overflow-y-auto custom-scrollbar p-2">
                                    {filtered.map(c => (
                                        <div key={c.id} onClick={() => setSelected(c)} className={`p-3 mb-2 rounded-xl cursor-pointer transition ${selected.id === c.id ? 'bg-purple-600' : 'hover:bg-white/5'}`}>
                                            <div className="font-bold text-sm">{c.name}</div>
                                            <div className="flex justify-between text-xs opacity-60 mt-1">
                                                <span>NL: {c.metrics.NL}</span>
                                                <span>Score: {calculateSecurityScore(c.metrics)}%</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Main Content */}
                            <div className="lg:col-span-3 space-y-6">
                                <div className="flex gap-2 p-1 bg-black/40 rounded-xl w-fit border border-white/10">
                                    <button onClick={() => setActiveTab('analysis')} className={`px-6 py-2 rounded-lg font-bold transition ${activeTab === 'analysis' ? 'bg-purple-600' : ''}`}>Analysis</button>
                                    <button onClick={() => setActiveTab('encryption')} className={`px-6 py-2 rounded-lg font-bold transition ${activeTab === 'encryption' ? 'bg-purple-600' : ''}`}>Encryption</button>
                                </div>

                                {activeTab === 'analysis' ? (
                                    <div className="space-y-6">
                                        <div className="glass-card p-6 rounded-3xl grid grid-cols-1 md:grid-cols-2 gap-8">
                                            <div>
                                                <h2 className="text-3xl font-black mb-2 text-white">{selected.id}</h2>
                                                <p className="text-purple-400 mb-6 font-mono text-sm">{selected.name}</p>
                                                <div className="h-[300px]">
                                                    <ResponsiveContainer width="100%" height="100%">
                                                        <RadarChart cx="50%" cy="50%" outerRadius="80%" data={Object.keys(metricInfo).map(k => ({subject: k, A: getMetricScore(selected.metrics[k], k)}))}>
                                                            <PolarGrid stroke="#475569" />
                                                            <PolarAngleAxis dataKey="subject" tick={{fill: '#94a3b8'}} />
                                                            <Radar dataKey="A" stroke="#a855f7" fill="#a855f7" fillOpacity={0.5} />
                                                            <Tooltip />
                                                        </RadarChart>
                                                    </ResponsiveContainer>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-3">
                                                {Object.entries(selected.metrics).map(([k, v]) => (
                                                    <div key={k} className="bg-white/5 p-3 rounded-xl border border-white/5">
                                                        <div className="text-[10px] uppercase text-slate-500 font-black">{k}</div>
                                                        <div className="text-xl font-mono text-purple-400">{typeof v === 'number' ? v.toFixed(3) : v}</div>
                                                    </div>
                                                ))}
                                                <div className="col-span-2 bg-gradient-to-r from-purple-600 to-pink-600 p-4 rounded-xl mt-4">
                                                    <div className="text-xs font-bold uppercase">Security Rating</div>
                                                    <div className="text-4xl font-black">{calculateSecurityScore(selected.metrics)}%</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="glass-card p-6 rounded-3xl">
                                            <h3 className="text-xl font-bold mb-6">Top 5 Comparison</h3>
                                            <div className="h-[300px]">
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <BarChart data={Object.keys(metricInfo).map(k => {
                                                        const row = { metric: k };
                                                        filtered.slice(0, 5).forEach(c => row[c.id] = c.metrics[k]);
                                                        return row;
                                                    })}>
                                                        <CartesianGrid strokeDasharray="3 3" stroke="#ffffff10" />
                                                        <XAxis dataKey="metric" />
                                                        <YAxis />
                                                        <Tooltip contentStyle={{backgroundColor: '#000'}} />
                                                        <Legend />
                                                        {filtered.slice(0, 5).map((c, i) => <Bar key={c.id} dataKey={c.id} fill={['#a855f7','#ec4899','#8b5cf6','#d946ef','#c026d3'][i]} />)}
                                                    </BarChart>
                                                </ResponsiveContainer>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="glass-card p-8 rounded-3xl space-y-6">
                                        <div className="flex gap-4 mb-4">
                                            <button onClick={() => setMode('text')} className={`flex-1 p-3 rounded-xl border ${mode === 'text' ? 'bg-purple-600 border-purple-400' : 'border-white/10'}`}>Text Mode</button>
                                            <button onClick={() => setMode('hex')} className={`flex-1 p-3 rounded-xl border ${mode === 'hex' ? 'bg-purple-600 border-purple-400' : 'border-white/10'}`}>Hex Mode</button>
                                        </div>
                                        <textarea className="w-full bg-black/40 p-4 rounded-xl border border-white/10 font-mono text-purple-300" rows="4" placeholder={mode==='text'?'Ketik teks...':'Input Hex (e.g. 48 65 6c 6c 6f)'} value={input} onChange={e => setInput(e.target.value)} />
                                        <div className="flex gap-4">
                                            <button onClick={() => handleProcess('enc')} className="flex-1 bg-green-600 py-3 rounded-xl font-black">ENCRYPT</button>
                                            <button onClick={() => handleProcess('dec')} className="flex-1 bg-blue-600 py-3 rounded-xl font-black">DECRYPT</button>
                                        </div>
                                        <div className="space-y-4 pt-4 border-t border-white/10">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase">Output Hex</label>
                                                <div className="p-4 bg-black/60 rounded-xl font-mono text-green-400 break-all border border-white/5">{outputHex || '---'}</div>
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase">Output Text</label>
                                                <div className="p-4 bg-black/60 rounded-xl font-mono text-purple-400 break-all border border-white/5">{outputText || '---'}</div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SboxAnalyzer />);
    </script>
</body>
</html>

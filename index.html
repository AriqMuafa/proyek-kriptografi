<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S-box Cryptographic Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    gridTemplateColumns: {
                        '16': 'repeat(16, minmax(0, 1fr))', // Menambahkan support 16 kolom
                    },
                    gridTemplateRows: {
                        '16': 'repeat(16, minmax(0, 1fr))', // Menambahkan support 16 baris
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }
        .sbox-cell { font-size: 0.6rem; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 10px; }
        /* Loading Spinner */
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 12px; height: 12px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800">

    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-[1600px] mx-auto px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg shadow-blue-200">
                    <i class="fas fa-shield-alt fa-lg"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl text-slate-800 leading-tight">S-box Cryptographic Analyzer</h1>
                    <p class="text-[10px] text-slate-500 font-medium tracking-wide">Ultimate S-box Data | 10 Metrics Analysis</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4 bg-slate-50 p-1.5 rounded-lg border border-slate-200">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                    <input type="text" placeholder="Search 8 boxes..." class="pl-8 pr-4 py-1.5 bg-white border border-slate-200 rounded text-xs w-48 focus:outline-none focus:border-blue-500">
                </div>
                <div class="flex items-center gap-2 px-3 border-l border-slate-200">
                    <i class="fas fa-filter text-slate-400 text-xs"></i>
                    <select class="bg-transparent text-xs font-medium text-slate-600 focus:outline-none">
                        <option>All Categories</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-2">
                <button class="px-3 py-1.5 bg-blue-50 text-blue-600 text-xs font-bold rounded shadow-sm hover:bg-blue-100">128 S-Boxes</button>
                <button class="px-3 py-1.5 bg-green-50 text-green-600 text-xs font-bold rounded shadow-sm hover:bg-green-100">10 Metrics</button>
                <button class="px-3 py-1.5 bg-indigo-50 text-indigo-600 text-xs font-bold rounded shadow-sm hover:bg-indigo-100">AES-128</button>
            </div>
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto px-6 py-6 grid grid-cols-12 gap-6">
        
        <aside class="col-span-12 xl:col-span-3 space-y-5">
            
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="text-xs font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-chevron-right text-blue-500"></i> Select S-box Configuration
                </h3>
                <select id="sboxSelect" class="w-full p-2.5 mb-4 text-sm bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-slate-700 font-medium">
                    <option>Loading...</option>
                </select>

                <div class="bg-slate-50 rounded-xl p-4 border border-slate-100 mb-4 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-2 relative z-10">
                        <div>
                            <h2 id="metaName" class="font-bold text-slate-800 text-sm">AES Standard (FIPS 197)</h2>
                            <p class="text-[10px] text-slate-500 mt-0.5">ID: <span id="metaId">AES_STD</span></p>
                        </div>
                        <span id="metaType" class="bg-blue-600 text-white text-[9px] px-2 py-0.5 rounded shadow-sm shadow-blue-200">Standard</span>
                    </div>
                    <p class="text-[10px] text-slate-500 leading-relaxed mb-4 relative z-10">
                        Cryptographic S-box candidate with standard classification metrics.
                    </p>

                    <div class="grid grid-cols-2 gap-2 mb-3 relative z-10">
                        <div class="bg-white p-2 rounded border border-blue-100">
                            <span class="block text-[9px] text-blue-500 font-bold">Matrix Size</span>
                            <span class="block text-xs font-bold text-slate-700">8x8</span>
                        </div>
                        <div class="bg-white p-2 rounded border border-blue-100">
                            <span class="block text-[9px] text-blue-500 font-bold">S-box Size</span>
                            <span class="block text-xs font-bold text-slate-700">256 bytes</span>
                        </div>
                        <div class="bg-white p-2 rounded border border-green-100">
                            <span class="block text-[9px] text-green-600 font-bold">Nonlinearity</span>
                            <span id="cardNL" class="block text-xs font-bold text-slate-700">112</span>
                        </div>
                        <div class="bg-white p-2 rounded border border-green-100">
                            <span class="block text-[9px] text-green-600 font-bold">SAC Score</span>
                            <span id="cardSAC" class="block text-xs font-bold text-slate-700">0.5048</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 mb-4 relative z-10">
                        <i class="fas fa-check-circle text-green-500 text-xs"></i>
                        <span class="text-[10px] font-medium text-green-700">Encryption Enabled</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="text-xs font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <i class="fas fa-th text-purple-500"></i> Affine Transformation Matrix
                </h3>
                <div class="grid grid-cols-8 gap-1 aspect-square bg-slate-50 p-2 rounded-lg border border-slate-100" id="affineGrid">
                    </div>
            </div>

        </aside>

        <section class="col-span-12 xl:col-span-9 space-y-6">
            
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6 h-auto">
                
                <div class="col-span-12 md:col-span-7 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-sm text-slate-700">Substitution Table Visualization (16x16 Matrix)</h3>
                        <div class="flex items-center gap-2">
                            <span class="text-[9px] text-slate-400 font-bold">Low (0x00)</span>
                            <div class="w-16 h-2 bg-gradient-to-r from-blue-100 to-blue-900 rounded-full"></div>
                            <span class="text-[9px] text-slate-400 font-bold">High (0xFF)</span>
                        </div>
                    </div>
                    
                    <div class="flex mb-1 ml-6">
                        <div class="flex-1 flex text-[9px] text-slate-400 font-bold justify-between px-1">
                            <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span>
                            <span>8</span><span>9</span><span>A</span><span>B</span><span>C</span><span>D</span><span>E</span><span>F</span>
                        </div>
                    </div>
                    
                    <div class="flex flex-1">
                        <div class="w-6 flex flex-col justify-between text-[9px] text-slate-400 font-bold py-1">
                            <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span>
                            <span>8</span><span>9</span><span>A</span><span>B</span><span>C</span><span>D</span><span>E</span><span>F</span>
                        </div>
                        <div id="sboxGrid" class="w-full aspect-square grid grid-cols-16 grid-rows-16 gap-[1px] bg-slate-200 border border-slate-200 rounded overflow-hidden">
                            </div>
                    </div>
                </div>

                <div class="col-span-12 md:col-span-5 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col">
                    <h3 class="font-bold text-sm text-slate-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-bolt text-yellow-500"></i> Cryptographic Security Metrics Distribution
                    </h3>
                    <div class="flex-1 relative flex items-center justify-center min-h-[300px]">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex items-center gap-2 mb-6">
                    <div class="bg-green-100 p-1.5 rounded text-green-600"><i class="fas fa-chart-bar"></i></div>
                    <h3 class="font-bold text-base text-slate-800">Comprehensive Metrics Evaluation (10 Metrics)</h3>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4" id="metricsGrid">
                    </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-full">
                    <div class="flex items-center gap-2 mb-4 border-b border-slate-100 pb-3">
                        <div class="bg-indigo-100 p-1.5 rounded text-indigo-600"><i class="fas fa-font"></i></div>
                        <h3 class="font-bold text-base text-slate-800">Text Encryption</h3>
                    </div>

                    <div class="space-y-4">
                        <div class="flex bg-slate-100 rounded-lg p-1">
                            <button id="btnTextEnc" onclick="setTextMode('encrypt')" class="flex-1 py-1.5 rounded-md text-xs font-bold text-white bg-indigo-600 shadow-sm transition">Encrypt</button>
                            <button id="btnTextDec" onclick="setTextMode('decrypt')" class="flex-1 py-1.5 rounded-md text-xs font-bold text-slate-500 hover:text-slate-700 transition">Decrypt</button>
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">Secret Key</label>
                            <input type="text" id="textKey" placeholder="Enter key..." class="w-full p-2.5 text-xs bg-slate-50 border border-slate-200 rounded-lg focus:border-indigo-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">Message Input</label>
                            <textarea id="textInput" rows="3" placeholder="Type message here..." class="w-full p-2.5 text-xs bg-slate-50 border border-slate-200 rounded-lg focus:border-indigo-500 outline-none font-mono"></textarea>
                        </div>

                        <button onclick="processText()" class="w-full bg-slate-800 hover:bg-slate-900 text-white text-xs font-bold py-2.5 rounded-lg shadow-sm transition">
                            Process Text
                        </button>

                        <div class="mt-2">
                            <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">Result</label>
                            <div id="textResult" class="bg-green-50 border border-green-100 rounded-lg p-3 text-xs font-mono text-green-800 break-all h-24 overflow-y-auto">
                                Waiting for input...
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-full">
                    <div class="flex items-center gap-2 mb-4 border-b border-slate-100 pb-3">
                        <div class="bg-pink-100 p-1.5 rounded text-pink-600"><i class="fas fa-image"></i></div>
                        <h3 class="font-bold text-base text-slate-800">Image Encryption</h3>
                    </div>

                    <div class="space-y-4">
                        <div class="flex bg-slate-100 rounded-lg p-1">
                            <button id="btnImgEnc" onclick="setImgMode('encrypt')" class="flex-1 py-1.5 rounded-md text-xs font-bold text-white bg-pink-600 shadow-sm transition">Encrypt</button>
                            <button id="btnImgDec" onclick="setImgMode('decrypt')" class="flex-1 py-1.5 rounded-md text-xs font-bold text-slate-500 hover:text-slate-700 transition">Decrypt</button>
                        </div>

                        <div class="relative border-2 border-dashed border-slate-200 rounded-xl bg-slate-50 hover:bg-slate-100 transition p-4 text-center group">
                            <input type="file" id="imageInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div class="flex flex-col items-center justify-center gap-2">
                                <i class="fas fa-cloud-upload-alt text-2xl text-slate-300 group-hover:text-pink-400 transition"></i>
                                <p class="text-[10px] font-bold text-slate-400 group-hover:text-slate-600">Click to upload image</p>
                                <p id="fileName" class="text-[9px] text-pink-600 font-mono hidden">filename.png</p>
                            </div>
                        </div>

                        <button onclick="processImage()" class="w-full bg-slate-800 hover:bg-slate-900 text-white text-xs font-bold py-2.5 rounded-lg shadow-sm transition flex items-center justify-center gap-2">
                            <span>Process Image</span>
                            <div id="imgLoader" class="loader hidden"></div>
                        </button>

                        <div class="mt-2">
                            <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">Image Result</label>
                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-2 h-32 flex items-center justify-center overflow-hidden relative">
                                <span id="imgPlaceholder" class="text-[9px] text-slate-400 italic">No image processed yet</span>
                                <img id="imageResult" class="max-w-full max-h-full object-contain rounded shadow-sm hidden">
                                <a id="downloadLink" href="#" download="result.png" class="absolute bottom-2 right-2 bg-white/80 p-1.5 rounded-full shadow hover:bg-white hidden text-slate-700">
                                    <i class="fas fa-download text-xs"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </section>
    </main>

    <footer class="max-w-[1600px] mx-auto px-6 py-8 flex justify-between items-center text-[10px] text-slate-400 border-t border-slate-200 mt-6">
        <p>S-box Cryptographic Analyzer Â© 2025</p>
        <p>Using FastAPI & Tailwind</p>
    </footer>

    <script>
        let sboxData = [];
        let currentSboxId = "AES_STD";
        let textMode = 'encrypt';
        let imgMode = 'encrypt';
        let radarChartInstance = null;

        // --- MOCKUP DATA FOR AFFINE MATRIX (Visual Only) ---
        const affinePattern = [1,0,0,0,1,1,1,1, 1,1,0,0,0,1,1,1, 1,1,1,0,0,0,1,1, 1,1,1,1,0,0,0,1, 1,1,1,1,1,0,0,0, 0,1,1,1,1,1,0,0, 0,0,1,1,1,1,1,0, 0,0,0,1,1,1,1,1];

        // --- INIT ---
        async function init() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                sboxData = data.candidates;
                populateDropdown();
                renderAffineGrid();
                updateDashboard(currentSboxId);
            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('metaName').innerText = "Error loading backend data";
            }
        }

        // --- RENDER FUNCTIONS ---
        function populateDropdown() {
            const select = document.getElementById('sboxSelect');
            select.innerHTML = '';
            sboxData.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.innerText = item.name;
                select.appendChild(opt);
            });
            select.addEventListener('change', (e) => updateDashboard(e.target.value));
        }

        function renderAffineGrid() {
            const grid = document.getElementById('affineGrid');
            grid.innerHTML = '';
            affinePattern.forEach(val => {
                const div = document.createElement('div');
                div.className = `rounded-sm flex items-center justify-center text-[6px] font-bold ${val ? 'bg-indigo-700 text-white' : 'bg-white text-slate-300'}`;
                div.innerText = val;
                grid.appendChild(div);
            });
        }

        async function updateDashboard(id) {
            currentSboxId = id;
            const candidate = sboxData.find(x => x.id === id);
            if (!candidate) return;

            document.getElementById('metaName').innerText = candidate.name;
            document.getElementById('metaId').innerText = candidate.id;
            document.getElementById('metaType').innerText = candidate.type.toUpperCase();
            document.getElementById('cardNL').innerText = candidate.metrics.NL;
            document.getElementById('cardSAC').innerText = candidate.metrics.SAC.toFixed(4);

            renderMetricsCards(candidate.metrics);
            updateCharts(candidate);
            
            try {
                const res = await fetch(`/api/sbox-values/${id}`);
                const data = await res.json();
                renderSboxGrid(data.sbox);
            } catch(e) { console.error(e); }
        }

        function renderSboxGrid(values) {
            const grid = document.getElementById('sboxGrid');
            grid.innerHTML = '';
            values.forEach(val => {
                const div = document.createElement('div');
                const opacity = 0.1 + (val / 255) * 0.9;
                const bgColor = `rgba(59, 130, 246, ${opacity})`; 
                const textColor = val > 128 ? 'white' : '#1e293b';

                div.className = 'flex items-center justify-center text-[7px] font-mono cursor-default hover:border hover:border-yellow-400 transition-colors';
                div.style.backgroundColor = bgColor;
                div.style.color = textColor;
                div.innerText = val.toString(16).toUpperCase().padStart(2, '0');
                div.title = `Dec: ${val} | Hex: ${div.innerText}`;
                grid.appendChild(div);
            });
        }

        // --- UPDATED: RENDER 10 METRICS CARDS ---
        function renderMetricsCards(m) {
            const container = document.getElementById('metricsGrid');
            container.innerHTML = '';
            
            // Definisi 10 Metrik Lengkap
            const metricsDef = [
                { k: 'NL', label: 'NONLINEARITY', target: 'Target: 112', icon: 'fa-shield-alt', color: 'text-purple-600', bg: 'bg-purple-100' },
                { k: 'SAC', label: 'SAC', target: 'Ideal: 0.5', icon: 'fa-bolt', color: 'text-blue-600', bg: 'bg-blue-100' },
                { k: 'BIC_NL', label: 'BIC-NL', target: 'Target: 112', icon: 'fa-cube', color: 'text-green-600', bg: 'bg-green-100' },
                { k: 'BIC_SAC', label: 'BIC-SAC', target: 'Ideal: 0.5', icon: 'fa-chart-area', color: 'text-orange-600', bg: 'bg-orange-100' },
                { k: 'LAP', label: 'LIN. APPROX', target: 'Minimize', icon: 'fa-balance-scale', color: 'text-pink-600', bg: 'bg-pink-100' },
                
                // 5 Metrik Tambahan
                { k: 'DAP', label: 'DIFF. APPROX', target: 'Minimize', icon: 'fa-compress-arrows-alt', color: 'text-teal-600', bg: 'bg-teal-100' },
                { k: 'DU', label: 'DIFF. UNIFORMITY', target: 'Ideal: 4', icon: 'fa-code-branch', color: 'text-indigo-600', bg: 'bg-indigo-100' },
                { k: 'AD', label: 'ALG. DEGREE', target: 'Max: 7', icon: 'fa-superscript', color: 'text-red-600', bg: 'bg-red-100' },
                { k: 'TO', label: 'TRANSP. ORDER', target: 'Minimize', icon: 'fa-eye', color: 'text-cyan-600', bg: 'bg-cyan-100' },
                { k: 'CI', label: 'CORR. IMMUNITY', target: 'Maximize', icon: 'fa-lock', color: 'text-slate-600', bg: 'bg-slate-100' }
            ];

            metricsDef.forEach(def => {
                let val = m[def.k];
                // Format decimal values, leave integers alone
                if(typeof val === 'number' && val % 1 !== 0) val = val.toFixed(4);
                
                const html = `
                    <div class="bg-white p-3 rounded-xl border border-slate-100 hover:shadow-md transition">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="${def.bg} p-1.5 rounded-full ${def.color}"><i class="fas ${def.icon} text-xs"></i></div>
                            <span class="text-[9px] font-bold text-slate-500 uppercase">${def.label}</span>
                        </div>
                        <div class="text-lg font-bold text-slate-800 leading-none mb-1">${val}</div>
                        <div class="text-[8px] text-slate-400 font-medium">${def.target}</div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function updateCharts(candidate) {
            const m = candidate.metrics;
            const radarCtx = document.getElementById('radarChart').getContext('2d');
            
            // Normalize data for chart (example logic)
            const radarData = [
                m.NL/112, 
                m.SAC*2, 
                m.BIC_NL/112, 
                m.BIC_SAC*2, 
                1-(m.LAP*4), 
                1-(m.DAP*10)
            ];
            
            if(radarChartInstance) radarChartInstance.destroy();
            radarChartInstance = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: ['NL', 'SAC', 'BIC-NL', 'BIC-SAC', 'LAP', 'DAP'],
                    datasets: [{
                        label: 'Metrics',
                        data: radarData,
                        backgroundColor: 'rgba(99, 102, 241, 0.4)',
                        borderColor: '#6366f1',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { r: { ticks: { display: false, max: 1 } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- TEXT ENCRYPTION LOGIC ---
        function setTextMode(mode) {
            textMode = mode;
            const btnEnc = document.getElementById('btnTextEnc');
            const btnDec = document.getElementById('btnTextDec');
            
            const activeClass = "flex-1 py-1.5 rounded-md text-xs font-bold text-white bg-indigo-600 shadow-sm transition";
            const inactiveClass = "flex-1 py-1.5 rounded-md text-xs font-bold text-slate-500 hover:text-slate-700 transition";
            
            if(mode === 'encrypt') {
                btnEnc.className = activeClass;
                btnDec.className = inactiveClass;
            } else {
                btnEnc.className = inactiveClass;
                btnDec.className = activeClass;
            }
        }

        async function processText() {
            const text = document.getElementById('textInput').value;
            const key = document.getElementById('textKey').value;
            const resultBox = document.getElementById('textResult');

            if(!text || !key) { alert("Please enter text and key."); return; }
            resultBox.innerText = "Processing...";

            const endpoint = textMode === 'encrypt' ? '/api/encrypt-text' : '/api/decrypt-text';
            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text, key, sbox_id: currentSboxId })
                });
                const data = await res.json();
                resultBox.innerText = data.error ? "Error: " + data.error : data.result;
            } catch(e) { resultBox.innerText = "Network Error"; }
        }

        // --- IMAGE ENCRYPTION LOGIC ---
        function setImgMode(mode) {
            imgMode = mode;
            const btnEnc = document.getElementById('btnImgEnc');
            const btnDec = document.getElementById('btnImgDec');
            
            const activeClass = "flex-1 py-1.5 rounded-md text-xs font-bold text-white bg-pink-600 shadow-sm transition";
            const inactiveClass = "flex-1 py-1.5 rounded-md text-xs font-bold text-slate-500 hover:text-slate-700 transition";
            
            if(mode === 'encrypt') {
                btnEnc.className = activeClass;
                btnDec.className = inactiveClass;
            } else {
                btnEnc.className = inactiveClass;
                btnDec.className = activeClass;
            }
        }

        document.getElementById('imageInput').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name;
            const nameDisplay = document.getElementById('fileName');
            if(fileName) {
                nameDisplay.innerText = fileName;
                nameDisplay.classList.remove('hidden');
            }
        });

        async function processImage() {
            const input = document.getElementById('imageInput');
            const loader = document.getElementById('imgLoader');
            const resultImg = document.getElementById('imageResult');
            const placeholder = document.getElementById('imgPlaceholder');
            const downloadLink = document.getElementById('downloadLink');

            if(input.files.length === 0) { alert("Select an image first"); return; }
            
            loader.classList.remove('hidden');
            
            const formData = new FormData();
            formData.append('file', input.files[0]);
            formData.append('sbox_id', currentSboxId);
            formData.append('mode', imgMode);

            try {
                const res = await fetch('/api/process-image', { method: 'POST', body: formData });
                const data = await res.json();
                
                if(data.status === 'success') {
                    resultImg.src = data.image_data;
                    resultImg.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    downloadLink.href = data.image_data;
                    downloadLink.classList.remove('hidden');
                } else {
                    alert("Error: " + data.message);
                }
            } catch (e) { 
                alert("Processing Failed"); 
            } finally {
                loader.classList.add('hidden');
            }
        }

        // Run
        init();
    </script>
</body>
</html>
